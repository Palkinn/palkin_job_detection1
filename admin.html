<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #2c3e50; color: white; height: 100vh; padding: 20px; position: fixed; }
        .sidebar h2 { text-align: center; margin-bottom: 40px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 10px; transition: 0.3s; }
        .menu-item:hover, .active { background: #34495e; }
        .menu-item span { margin-left: 10px; }
        
        /* Main Content */
        .main { margin-left: 270px; padding: 30px; width: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Stats Cards */
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { font-size: 2.5rem; margin: 10px 0; color: #2c3e50; }
        .card p { color: #7f8c8d; }
        
        /* Charts Section */
        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* Table */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #2c3e50; color: white; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; color: white; }
        .btn-danger { background: #e74c3c; }
        .btn-success { background: #27ae60; }
        .btn-blue { background: #3498db; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üõ°Ô∏è Admin</h2>
        <div class="menu-item active">üìä Dashboard</div>
        <div class="menu-item" onclick="exportData()">üì• Export Data</div>
        <div class="menu-item" onclick="retrainModel()">‚öôÔ∏è Retrain Model</div>
        <div class="menu-item" style="margin-top: 50px; background: #c0392b;" onclick="logout()">üö™ Logout</div>
    </div>

    <div class="main">
        <div class="header">
            <h1>System Overview</h1>
            <div>
                <span id="status" style="color: green;">‚óè System Operational</span> | Version: <span id="modelVersion">v1.0</span>
            </div>
        </div>

        <div class="cards">
            <div class="card">
                <h3 id="totalPreds">0</h3>
                <p>Total Predictions</p>
            </div>
            <div class="card">
                <h3 id="fakeCount" style="color: #e74c3c;">0</h3>
                <p>Fake Jobs Detected</p>
            </div>
            <div class="card">
                <h3 id="realCount" style="color: #27ae60;">0</h3>
                <p>Real Jobs Verified</p>
            </div>
            <div class="card">
                <h3 id="flagCount">0</h3>
                <p>User Flags</p>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <h4>Prediction Trends (Live)</h4>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-box">
                <h4>Distribution</h4>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <h3>üö© Recent Flagged Jobs</h3>
        <table id="flagTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Reason</th>
                    <th>Snippet</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const token = localStorage.getItem('access_token');
        if (!token) window.location.href = 'login.html';

        // Load Stats & Charts
        async function loadDashboard() {
            try {
                // 1. Fetch Stats
                const resStats = await fetch('http://127.0.0.1:8000/admin/stats', { headers: { 'Authorization': 'Bearer ' + token } });
                const stats = await resStats.json();
                
                document.getElementById('totalPreds').innerText = stats.total;
                document.getElementById('fakeCount').innerText = stats.fake;
                document.getElementById('realCount').innerText = stats.real;
                document.getElementById('modelVersion').innerText = stats.model_version;

                // 2. Render Charts
                renderCharts(stats.real, stats.fake);

                // 3. Fetch Flags
                const resFlags = await fetch('http://127.0.0.1:8000/admin/flagged-jobs', { headers: { 'Authorization': 'Bearer ' + token } });
                const flags = await resFlags.json();
                document.getElementById('flagCount').innerText = flags.length;
                
                const tbody = document.querySelector('#flagTable tbody');
                tbody.innerHTML = '';
                flags.slice(-5).reverse().forEach(f => {
                    tbody.innerHTML += `<tr>
                        <td>${f.timestamp.split('T')[0]}</td>
                        <td>${f.reason}</td>
                        <td>${f.snippet}...</td>
                        <td><span style="padding:5px 10px; background:#f1c40f; border-radius:4px; font-size:0.8rem">Pending</span></td>
                    </tr>`;
                });

            } catch (e) { console.error(e); }
        }

        let myPieChart, myBarChart;

        function renderCharts(real, fake) {
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            const ctxBar = document.getElementById('barChart').getContext('2d');

            if(myPieChart) myPieChart.destroy();
            if(myBarChart) myBarChart.destroy();

            myPieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Real', 'Fake'],
                    datasets: [{ data: [real, fake], backgroundColor: ['#27ae60', '#e74c3c'] }]
                }
            });

            myBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Total Activity'],
                    datasets: [
                        { label: 'Real', data: [real], backgroundColor: '#27ae60' },
                        { label: 'Fake', data: [fake], backgroundColor: '#e74c3c' }
                    ]
                }
            });
        }

        async function retrainModel() {
            alert("Starting Model Retraining... This may take a few seconds.");
            const res = await fetch('http://127.0.0.1:8000/admin/retrain', { 
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token } 
            });
            const data = await res.json();
            alert(data.message + " New Version: " + data.new_version);
            location.reload();
        }

        async function exportData() {
            const res = await fetch('http://127.0.0.1:8000/admin/export', { headers: { 'Authorization': 'Bearer ' + token } });
            if(res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "flagged_jobs_report.csv";
                a.click();
            } else { alert("No data to export!"); }
        }

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }

        loadDashboard();
    </script>
</body>
</html>